<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tower Builder - LenGame</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background-image: url('background.png');
      background-size: cover;
      background-position: center;
    }

    canvas {
      display: block;
      background: #fff;
      margin: 0 auto;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    #ui {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      padding: 10px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: flex;
      gap: 20px;
      align-items: center;
      user-select: none;
    }

    #ui div {
      font-size: 1.1em;
      font-weight: bold;
    }

    #shopBtn {
      background: #4CAF50;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    #shop {
      position: absolute;
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.98);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      display: none;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      z-index: 10;
      max-width: 90vw;
    }

    .skin {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      font-weight: bold;
      color: white;
      font-size: 0.9em;
      position: relative;
      text-shadow: 1px 1px 2px black;
    }

    .selected {
      outline: 4px solid #333;
    }

    .locked {
      filter: grayscale(0.8);
    }

    .locked::after {
      content: "ðŸ”’";
      position: absolute;
      top: 4px;
      right: 6px;
      font-size: 1.2em;
    }

    .price-tag {
      position: absolute;
      bottom: 6px;
      right: 8px;
      background: rgba(0,0,0,0.6);
      color: white;
      padding: 2px 6px;
      border-radius: 6px;
      font-size: 0.75em;
    }

    #shopInfo {
      width: 100%;
      text-align: center;
      margin-bottom: 10px;
      font-size: 0.95em;
      color: #555;
    }
  </style>
</head>
<body>
  <div id="ui">
    <div id="score">Score: 0</div>
    <div id="coins">Coins: 0</div>
    <button id="shopBtn">Shop</button>
  </div>

  <div id="shop">
    <div id="shopInfo">Tippe auf ein Skin, um es zu kaufen oder zu aktivieren</div>
  </div>

  <canvas id="gameCanvas"></canvas>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // === Game State ===
    let stack = [{ x: canvas.width / 2 - 100, y: 0, width: 200 }];
    let currentBlock = { x: 0, y: 30, width: 200, dir: 3 };
    let score = 0;
    let coins = parseInt(localStorage.getItem("coins") || "0");
    let skin = localStorage.getItem("skin") || "classic";
    let unlockedSkins = JSON.parse(localStorage.getItem("unlockedSkins") || `["classic"]`);
    let cameraOffset = 0;
    let gameOver = false;

    const skinPrices = {
      classic: 0,
      rainbow: 50,
      fire: 50,
      ice: 50,
      dark: 50,
      gold: 1000
    };

    const skins = {
      classic: ["#4CAF50"],
      rainbow: ["#f44336", "#ff9800", "#ffeb3b", "#4caf50", "#2196f3", "#9c27b0"],
      fire: ["#ff5722", "#ff9800", "#ffc107"],
      ice: ["#00bcd4", "#03a9f4", "#2196f3"],
      dark: ["#444", "#666", "#222"],
      gold: ["#FFD700", "#FFC700", "#FFB700"]
    };

    const skinColors = Object.entries(skins);

    // === UI ===
    const scoreDiv = document.getElementById("score");
    const coinsDiv = document.getElementById("coins");
    const shopBtn = document.getElementById("shopBtn");
    const shop = document.getElementById("shop");

    function updateUI() {
      scoreDiv.textContent = `Score: ${score}`;
      coinsDiv.textContent = `Coins: ${coins}`;
    }

    function drawBlock(b, y, color) {
      ctx.fillStyle = color;
      ctx.fillRect(b.x, y, b.width, 30);
      ctx.strokeStyle = "rgba(0,0,0,0.1)";
      ctx.strokeRect(b.x, y, b.width, 30);
    }

    function getBlockColor(index) {
      const scheme = skins[skin];
      return scheme[index % scheme.length];
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      cameraOffset += ((currentBlock.y - cameraOffset - canvas.height / 2 + 100) * 0.05);

      stack.forEach((b, i) => {
        const y = canvas.height - (b.y - cameraOffset);
        drawBlock(b, y, getBlockColor(i));
      });

      if (!gameOver) {
        const y = canvas.height - (currentBlock.y - cameraOffset);
        drawBlock(currentBlock, y, getBlockColor(score));
      }
    }

    function update() {
      if (gameOver) return;
      currentBlock.x += currentBlock.dir;
      if (currentBlock.x <= 0 || currentBlock.x + currentBlock.width >= canvas.width) {
        currentBlock.dir *= -1;
      }
      draw();
      requestAnimationFrame(update);
    }

    function placeBlock() {
      const last = stack[stack.length - 1];
      const overlap = Math.min(currentBlock.x + currentBlock.width, last.x + last.width) - Math.max(currentBlock.x, last.x);

      if (overlap <= 0) {
        gameOver = true;
        scoreDiv.textContent += " â€“ Game Over (Klick fÃ¼r Neustart)";
        return;
      }

      const newWidth = overlap;
      const newX = Math.max(currentBlock.x, last.x);
      stack.push({ x: newX, y: currentBlock.y, width: newWidth });
      score++;
      coins++;
      localStorage.setItem("coins", coins);
      updateUI();

      currentBlock = {
        x: 0,
        y: stack[stack.length - 1].y + 30,
        width: newWidth,
        dir: 3 + score * 0.1
      };
    }

    canvas.addEventListener("click", () => {
      if (gameOver) {
        resetGame();
      } else {
        placeBlock();
      }
    });

    canvas.addEventListener("touchstart", e => {
      e.preventDefault();
      canvas.click();
    }, { passive: false });

    function resetGame() {
      stack = [{ x: canvas.width / 2 - 100, y: 0, width: 200 }];
      currentBlock = { x: 0, y: 30, width: 200, dir: 3 };
      score = 0;
      cameraOffset = 0;
      gameOver = false;
      updateUI();
      update();
    }

    function createShop() {
      shop.innerHTML = '';
      const info = document.createElement("div");
      info.id = "shopInfo";
      info.textContent = "Tippe auf ein Skin, um es zu kaufen oder zu aktivieren";
      shop.appendChild(info);

      skinColors.forEach(([name, colors]) => {
        const div = document.createElement("div");
        div.classList.add("skin");
        div.style.background = colors.length > 1 ? `linear-gradient(45deg, ${colors.join(",")})` : colors[0];
        div.textContent = name;

        const price = skinPrices[name] ?? 50;

        if (!unlockedSkins.includes(name)) {
          div.classList.add("locked");

          const priceTag = document.createElement("div");
          priceTag.className = "price-tag";
          priceTag.textContent = `${price} Coins`;
          div.appendChild(priceTag);

          div.addEventListener("click", () => {
            if (coins >= price) {
              coins -= price;
              unlockedSkins.push(name);
              localStorage.setItem("coins", coins);
              localStorage.setItem("unlockedSkins", JSON.stringify(unlockedSkins));
              updateUI();
              createShop();
            } else {
              alert(`Du brauchst ${price} Coins, um dieses Skin zu kaufen!`);
            }
          });
        } else {
          if (skin === name) div.classList.add("selected");
          div.addEventListener("click", () => {
            skin = name;
            localStorage.setItem("skin", skin);
            createShop();
          });
        }

        shop.appendChild(div);
      });
    }

    shopBtn.addEventListener("click", () => {
      shop.style.display = shop.style.display === "flex" ? "none" : "flex";
      createShop();
    });

    updateUI();
    update();
  </script>
</body>
</html>